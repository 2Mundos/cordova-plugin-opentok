// Generated by CoffeeScript 1.6.3
(function() {
  var DefaultHeight, DefaultWidth, OTPlugin, PublisherStreamId, PublisherTypeClass, SubscriberTypeClass, TBConnection, TBError, TBGenerateDomHelper, TBGetZIndex, TBPublisher, TBSession, TBStream, TBSubscriber, TBSuccess, TBUpdateObjects, VideoContainerClass, getPosition, pdebug, replaceWithVideoStream, streamElements,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  OTPlugin = "OpenTokPlugin";

  PublisherStreamId = "TBPublisher";

  PublisherTypeClass = "OT_publisher";

  SubscriberTypeClass = "OT_subscriber";

  VideoContainerClass = "OT_video-container";

  DefaultWidth = 264;

  DefaultHeight = 198;

  window.TB = {
    checkSystemRequirements: function() {
      return 1;
    },
    initPublisher: function(one, two, three) {
      return new TBPublisher(one, two, three);
    },
    initSession: function(sid) {
      return new TBSession(sid);
    },
    log: function(message) {
      return pdebug("TB LOG", message);
    },
    off: function(event, handler) {},
    on: function(event, handler) {
      if (event === "exception") {
        console.log("JS: TB Exception Handler added");
        return Cordova.exec(handler, TBError, OTPlugin, "exceptionHandler", []);
      }
    },
    setLogLevel: function(a) {
      return console.log("Log Level Set");
    },
    upgradeSystemRequirements: function() {
      return {};
    },
    updateViews: function() {
      return TBUpdateObjects();
    },
    addEventListener: function(event, handler) {
      return this.on(event, handler);
    },
    removeEventListener: function(type, handler) {
      return this.off(type, handler);
    }
  };

  TBPublisher = (function() {
    function TBPublisher(one, two, three) {
      var height, name, position, publishAudio, publishVideo, width, zIndex, _ref, _ref1, _ref2;
      this.sanitizeInputs(one, two, three);
      console.log("JS: Publish Called");
      width = 160;
      height = 120;
      name = "TBNameHolder";
      publishAudio = "true";
      publishVideo = "true";
      zIndex = TBGetZIndex(document.getElementById(this.domId));
      if ((this.properties != null)) {
        width = (_ref = this.properties.width) != null ? _ref : DefaultWidth;
        height = (_ref1 = this.properties.height) != null ? _ref1 : DefaultHeight;
        name = (_ref2 = this.properties.name) != null ? _ref2 : "";
        if ((this.properties.publishAudio != null) && this.properties.publishAudio === false) {
          publishAudio = "false";
        }
        if ((this.properties.publishVideo != null) && this.properties.publishVideo === false) {
          publishVideo = "false";
        }
      }
      position = getPosition(this.domId);
      console.log("first test publisher is getting created, position coordinates - top: " + position.top + ", left: " + position.left + ", width: " + position.width + ", height: " + position.height);
      replaceWithVideoStream(this.domId, PublisherStreamId, {
        width: width,
        height: height
      });
      position = getPosition(this.domId);
      console.log("publisher id is " + this.domId);
      console.log("publisher is getting created, position coordinates - top: " + position.top + ", left: " + position.left + ", width: " + position.width + ", height: " + position.height);
      TBUpdateObjects();
      Cordova.exec(TBSuccess, TBError, OTPlugin, "initPublisher", [name, position.top, position.left, width, height, zIndex, publishAudio, publishVideo]);
    }

    TBPublisher.prototype.destroy = function() {
      return Cordova.exec(TBSuccess, TBError, OTPlugin, "destroyPublisher", []);
    };

    TBPublisher.prototype.getImgData = function() {
      return "";
    };

    TBPublisher.prototype.getStyle = function() {
      return {};
    };

    TBPublisher.prototype.off = function(event, handler) {
      return this;
    };

    TBPublisher.prototype.on = function(event, handler) {
      if (event === "streamCreated") {
        return this;
      }
      if (event === "streamDestroyed") {
        return this;
      }
      return this;
    };

    TBPublisher.prototype.publishAudio = function(state) {
      this.publishMedia("publishAudio", state);
      return this;
    };

    TBPublisher.prototype.publishVideo = function(state) {
      this.publishMedia("publishVideo", state);
      return this;
    };

    TBPublisher.prototype.setStyle = function(style, value) {
      return this;
    };

    TBPublisher.prototype.publishMedia = function(media, state) {
      var publishState;
      if (media !== "publishAudio" && media !== "publishVideo") {
        return;
      }
      publishState = "true";
      if ((state != null) && (state === false || state === "false")) {
        publishState = "false";
      }
      pdebug("setting publishstate", {
        media: media,
        publishState: publishState
      });
      return Cordova.exec(TBSuccess, TBError, OTPlugin, media, [publishState]);
    };

    TBPublisher.prototype.sanitizeInputs = function(one, two, three) {
      var position;
      if ((three != null)) {
        this.apiKey = one;
        this.domId = two;
        this.properties = three;
      } else if ((two != null)) {
        if (typeof two === "object") {
          this.properties = two;
          if (document.getElementById(one)) {
            this.domId = one;
          } else {
            this.apiKey = one;
          }
        } else {
          this.apiKey = one;
          this.domId = two;
        }
      } else if ((one != null)) {
        if (typeof one === "object") {
          this.properties = one;
        } else if (document.getElementById(one)) {
          this.domId = one;
        }
      }
      this.apiKey = this.apiKey != null ? this.apiKey : "";
      this.properties = this.properties && typeof (this.properties === "object") ? this.properties : {};
      if (this.domId && document.getElementById(this.domId)) {
        if (!this.properties.width || !this.properties.height) {
          console.log("domId exists but properties width or height is not specified");
          position = getPosition(this.domId);
          console.log(" width: " + position.width + " and height: " + position.height + " for domId " + this.domId + ", and top: " + position.top + ", left: " + position.left);
          if (position.width > 0 && position.height > 0) {
            this.properties.width = position.width;
            this.properties.height = position.height;
          }
        }
      } else {
        this.domId = TBGenerateDomHelper();
      }
      return this.domId = this.domId && document.getElementById(this.domId) ? this.domId : TBGenerateDomHelper();
    };

    TBPublisher.prototype.removeEventListener = function(event, handler) {
      this.off(event, handler);
      return this;
    };

    return TBPublisher;

  })();

  TBSession = (function() {
    TBSession.prototype.connect = function(apiKey, token, properties) {
      if (properties == null) {
        properties = {};
      }
      console.log("JS: Connect Called");
      this.apiKey = apiKey;
      this.token = token;
      Cordova.exec(this.sessionConnectedHandler, TBError, OTPlugin, "connect", [this.apiKey, this.token]);
      Cordova.exec(this.streamDisconnectedHandler, TBError, OTPlugin, "streamDisconnectedHandler", []);
      Cordova.exec(this.sessionDisconnectedHandler, TBError, OTPlugin, "sessionDisconnectedHandler", []);
    };

    TBSession.prototype.disconnect = function() {
      return Cordova.exec(TBSuccess, TBError, OTPlugin, "disconnect", []);
    };

    TBSession.prototype.forceDisconnect = function(connection) {
      return this;
    };

    TBSession.prototype.forceUnpublish = function(stream) {
      return this;
    };

    TBSession.prototype.getPublisherForStream = function(stream) {
      return this;
    };

    TBSession.prototype.getSubscribersForStream = function(stream) {
      return this;
    };

    TBSession.prototype.off = function(event, handler) {
      return this;
    };

    TBSession.prototype.on = function(event, handler) {
      var _this = this;
      console.log("JS: Add Event Listener Called");
      switch (event) {
        case "sessionConnected":
          return this.sessionConnectedHandler = function(event) {
            console.log("session connected");
            _this.connection = event.connection;
            return handler(event);
          };
        case 'streamCreated':
          this.streamCreatedHandler = function(response) {
            var arr, stream;
            arr = response.split(' ');
            stream = new TBStream(arr[0], arr[1]);
            return handler({
              streams: [stream.toJSON()],
              stream: stream.toJSON()
            });
          };
          return Cordova.exec(this.streamCreatedHandler, TBSuccess, OTPlugin, "streamCreatedHandler", []);
        case 'streamDestroyed':
          return this.streamDisconnectedHandler = function(response) {
            var arr, stream;
            console.log("streamDestroyedHandler ");
            arr = response.split(' ');
            stream = new TBStream(arr[0], arr[1]);
            return handler({
              streams: [stream.toJSON()],
              stream: stream.toJSON()
            });
          };
        case 'sessionDisconnected':
          return this.sessionDisconnectedHandler = function(event) {
            return handler(event);
          };
      }
    };

    TBSession.prototype.publish = function(divName, properties) {
      this.publisher = new TBPublisher(divName, properties, this);
      return this.publisher;
    };

    TBSession.prototype.publish = function(publisher) {
      this.publisher = publisher;
      return Cordova.exec(TBSuccess, TBError, OTPlugin, "publish", []);
    };

    TBSession.prototype.signal = function(signal, handler) {
      return this;
    };

    TBSession.prototype.subscribe = function(one, two, three) {
      var domId, subscriber;
      if ((three != null)) {
        subscriber = new TBSubscriber(one, two, three);
        return subscriber;
      }
      if ((two != null)) {
        if (typeof two === "object") {
          domId = TBGenerateDomHelper();
          subscriber = new TBSubscriber(one, domId, two);
          return subscriber;
        } else {
          subscriber = new TBSubscriber(one, two, {});
          return subscriber;
        }
      }
      domId = TBGenerateDomHelper();
      subscriber = new TBSubscriber(one, domId, {});
      return subscriber;
    };

    TBSession.prototype.unpublish = function() {
      var element;
      console.log("JS: Unpublish");
      element = document.getElementById(this.publisher.domId);
      if (element) {
        element.parentNode.removeChild(element);
        TBUpdateObjects();
      }
      return Cordova.exec(TBSuccess, TBError, OTPlugin, "unpublish", []);
    };

    TBSession.prototype.unsubscribe = function(subscriber) {
      var element, elementId;
      console.log("JS: Unsubscribe");
      elementId = subscriber.streamId;
      element = document.getElementById("TBStreamConnection" + elementId);
      console.log("JS: Unsubscribing");
      element = streamElements[elementId];
      if (element) {
        element.parentNode.removeChild(element);
        delete streamElements[streamId];
        TBUpdateObjects();
      }
      return Cordova.exec(TBSuccess, TBError, OTPlugin, "unsubscribe", [subscriber.streamId]);
    };

    function TBSession(sessionId) {
      this.sessionId = sessionId;
      this.connect = __bind(this.connect, this);
      Cordova.exec(TBSuccess, TBSuccess, OTPlugin, "initSession", [this.sessionId]);
    }

    TBSession.prototype.cleanUpDom = function() {
      var e, objects, _i, _len, _results;
      objects = document.getElementsByClassName('OT_root');
      _results = [];
      for (_i = 0, _len = objects.length; _i < _len; _i++) {
        e = objects[_i];
        _results.push(e.parentNode.removeChild(e));
      }
      return _results;
    };

    TBSession.prototype.sessionDisconnectedHandler = function(event) {};

    TBSession.prototype.streamDisconnectedHandler = function(streamId) {
      var element;
      pdebug("stream disconnected handler", streamId);
      element = streamElements[streamId];
      pdebug("stream elements", streamElements);
      pdebug("stream element", element);
      if (element) {
        element.parentNode.removeChild(element);
        delete streamElements[streamId];
        TBUpdateObjects();
      }
    };

    TBSession.prototype.addEventListener = function(event, handler) {
      this.on(event, handler);
      return this;
    };

    TBSession.prototype.removeEventListener = function(event, handler) {
      this.off(event, handler);
      return this;
    };

    return TBSession;

  })();

  TBSubscriber = (function() {
    TBSubscriber.prototype.getAudioVolume = function() {
      return 0;
    };

    TBSubscriber.prototype.getImgData = function() {
      return "";
    };

    TBSubscriber.prototype.getStyle = function() {
      return {};
    };

    TBSubscriber.prototype.off = function(event, handler) {
      return this;
    };

    TBSubscriber.prototype.on = function(event, handler) {
      return this;
    };

    TBSubscriber.prototype.setAudioVolume = function(value) {
      return this;
    };

    TBSubscriber.prototype.setStyle = function(style, value) {
      return this;
    };

    TBSubscriber.prototype.subscribeToAudio = function(value) {
      return this;
    };

    TBSubscriber.prototype.subscribeToVideo = function(value) {
      return this;
    };

    function TBSubscriber(stream, divName, properties) {
      var divPosition, height, name, obj, position, subscribeToAudio, subscribeToVideo, width, zIndex, _ref, _ref1, _ref2, _ref3, _ref4;
      pdebug("creating subscriber", properties);
      this.streamId = stream.streamId;
      console.log("creating a subscriber, replacing div " + divName);
      divPosition = getPosition(divName);
      width = (_ref = divPosition.width) != null ? _ref : DefaultWidth;
      height = (_ref1 = divPosition.height) != null ? _ref1 : DefaultHeight;
      console.log("proposed width is " + width + ", and height " + height);
      subscribeToVideo = "true";
      zIndex = TBGetZIndex(document.getElementById(divName));
      if ((properties != null)) {
        width = (_ref2 = properties.width) != null ? _ref2 : width;
        height = (_ref3 = properties.height) != null ? _ref3 : height;
        name = (_ref4 = properties.name) != null ? _ref4 : "";
        subscribeToVideo = "true";
        subscribeToAudio = "true";
        if ((properties.subscribeToVideo != null) && properties.subscribeToVideo === false) {
          subscribeToVideo = "false";
        }
        if ((properties.subscribeToAudio != null) && properties.subscribeToAudio === false) {
          subscribeToAudio = "false";
        }
      }
      console.log("setting width to " + width + ", and height to " + height);
      obj = replaceWithVideoStream(divName, stream.streamId, {
        width: width,
        height: height
      });
      position = getPosition(obj.id);
      Cordova.exec(TBSuccess, TBError, OTPlugin, "subscribe", [stream.streamId, position.top, position.left, width, height, zIndex, subscribeToAudio, subscribeToVideo]);
    }

    TBSubscriber.prototype.removeEventListener = function(event, listener) {
      return this;
    };

    return TBSubscriber;

  })();

  TBStream = (function() {
    function TBStream(connectionId, streamId) {
      this.streamId = streamId;
      this.connection = new TBConnection(connectionId);
      this.creationTime = 0;
      this.hasAudio = true;
      this.hasVideo = true;
      this.videoDimensions = {
        width: 0,
        height: 0
      };
      this.name = "";
    }

    TBStream.prototype.toJSON = function() {
      return {
        streamId: this.streamId
      };
    };

    return TBStream;

  })();

  TBConnection = (function() {
    function TBConnection(connectionId) {
      this.connectionId = connectionId;
      return;
    }

    return TBConnection;

  })();

  streamElements = {};

  getPosition = function(divName) {
    var curleft, curtop, height, pubDiv, width;
    pubDiv = document.getElementById(divName);
    if (!pubDiv) {
      return {};
    }
    width = pubDiv.offsetWidth;
    height = pubDiv.offsetHeight;
    curtop = pubDiv.offsetTop;
    curleft = pubDiv.offsetLeft;
    while ((pubDiv = pubDiv.offsetParent)) {
      curleft += pubDiv.offsetLeft;
      curtop += pubDiv.offsetTop;
    }
    return {
      top: curtop,
      left: curleft,
      width: width,
      height: height
    };
  };

  replaceWithVideoStream = function(divName, streamId, properties) {
    var element, internalDiv, typeClass, videoElement;
    typeClass = streamId === PublisherStreamId ? PublisherTypeClass : SubscriberTypeClass;
    element = document.getElementById(divName);
    element.setAttribute("class", "OT_root " + typeClass);
    element.setAttribute("data-streamid", streamId);
    element.style.width = properties.width + "px";
    element.style.height = properties.height + "px";
    element.style.overflow = "hidden";
    element.style['background-color'] = "#000000";
    streamElements[streamId] = element;
    internalDiv = document.createElement("div");
    internalDiv.setAttribute("class", VideoContainerClass);
    internalDiv.style.width = "100%";
    internalDiv.style.height = "100%";
    internalDiv.style.left = "0px";
    internalDiv.style.top = "0px";
    videoElement = document.createElement("video");
    videoElement.style.width = "100%";
    videoElement.style.height = "100%";
    internalDiv.appendChild(videoElement);
    element.appendChild(internalDiv);
    return element;
  };

  TBError = function(error) {
    return navigator.notification.alert(error);
  };

  TBSuccess = function() {
    return console.log("success");
  };

  TBUpdateObjects = function() {
    var e, id, objects, position, streamId, _i, _len;
    console.log("JS: Objects being updated in TBUpdateObjects");
    objects = document.getElementsByClassName('OT_root');
    for (_i = 0, _len = objects.length; _i < _len; _i++) {
      e = objects[_i];
      console.log("JS: Object updated");
      streamId = e.dataset.streamid;
      console.log("JS sessionId: " + streamId);
      id = e.id;
      position = getPosition(id);
      Cordova.exec(TBSuccess, TBError, OTPlugin, "updateView", [streamId, position.top, position.left, position.width, position.height, TBGetZIndex(e)]);
    }
  };

  TBGenerateDomHelper = function() {
    var div, domId;
    domId = "PubSub" + Date.now();
    div = document.createElement('div');
    div.setAttribute('id', domId);
    document.body.appendChild(div);
    return domId;
  };

  window.TBTesting = function(handler) {
    return Cordova.exec(handler, TBError, OTPlugin, "TBTesting", []);
  };

  pdebug = function(msg, data) {
    return console.debug("JS Lib: " + msg + " - ", data);
  };

  TBGetZIndex = function(ele) {
    var val;
    while ((ele != null)) {
      val = document.defaultView.getComputedStyle(ele, null).getPropertyValue('z-index');
      console.log(val);
      if (parseInt(val)) {
        return val;
      }
      ele = ele.offsetParent;
    }
    return 0;
  };

}).call(this);
